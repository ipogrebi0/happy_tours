---
title: "Team Project"
author: "Faith Platz"
date: "10/15/2019"
output: pdf_document
---
# Libraries
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(rpart)
library(partykit)
library(woeBinning)
```

# Read in Data
```{r, message=FALSE}
#Preparing data and drop variables
tour <- read_csv("modeling_data.csv")
drop.vars <- c(grep("ID$|Trip_no|Grp_Size_Cat|^(Poor|Fair|Good|Excellent)", names(tour)))
tour %>% 
  mutate("Hotel_3orAbove" = Good_Hotels + Excellent_Hotels,
         "Meals_3orAbove" = Good_Meals + Excellent_Meals,
         "GUSS_3orAbove" = Good_GUSS + Excellent_GUSS,
         "Optionals_3orAbove" = Good_Optionals + Excellent_Optionals,
         "Bus_3orAbove" = Good_Buses + Excellent_Buses) %>% 
  select(-drop.vars, -contains("Gateway")) %>% 
  select(1:31, 59:63, everything()) -> tour

# Allocating variables
## Temporal variables
tour %>% select(1:2, 5:7, 13, 53:62) -> james

## Demographical/geographical/info variables
tour %>% select(3:4, 8:12, 37:45) -> faith0

## Evaluation variables
tour %>% select(22:36) -> irina

## Binary and some overall evaluation variables
tour %>% select(14:21, 46:52, 63) -> alex
```

```{r}
# add Book_12Mo to faith df
faith <- tour %>%
  select(names(faith0), Book_12Mo) %>%
  mutate_if(is.character, as.factor) %>%
  mutate(Book_12Mo = as.factor(Book_12Mo))
```

# create Region variable (I don't think we're actually going to use this)
```{r}
state_list <- bind_cols(list(state.abb, state.region))

state_transform <- faith %>%
  group_by(State) %>%
  summarize(n = n()) %>%
  left_join(state_list, by = c("State" = "V1")) %>%
  mutate(Region = if_else(State == "DC", "South", 
              if_else(is.na(V2), "Other", as.character(V2)))) %>%
  mutate(State = as.factor(State)) %>%
  select(State, Region) %>%
  ungroup()
```

# make some other modifications
```{r}
# now merge into actual dataset
faith1 <- faith %>%
  left_join(state_transform, by = "State") %>% 
  # fix mislabeling of TourPriceCat
  mutate(TourPriceCat = as.factor(if_else(as.character(TourPriceCat) == "More than 50", 
                                "More than 5000", as.character(TourPriceCat))),
         # turn Past_Trips into numeric variable
         Past_Trips = ifelse(as.character(Past_Trips) == "0 Trips", 0,
                      ifelse(as.character(Past_Trips) == "1 Trip", 1,
                      ifelse(as.character(Past_Trips) == "2 Trips", 2,
                      ifelse(as.character(Past_Trips) == "3 Trips", 3,
                      ifelse(as.character(Past_Trips) == "4 Trips", 4, NA))))))
```


# Weight of Evidence binning
```{r}
binning <- woe.binning(as.data.frame(faith1), 'Book_12Mo', 
                       c('State', 'TourCode', 'Tour_Region', 'SourceType'),
                       min.perc.total=0.05, min.perc.class=0.01, stop.limit=0.1)

faith2 <- woe.binning.deploy(as.data.frame(faith1), binning, add.woe.or.dum.var = 'woe')

levels(faith2$State.binned) <- c("NY+CA+misc", "Other", "PA+FL", "NA")
levels(faith2$TourCode.binned) <- c("Other", "VFR+MIT+misc", "VIB", "NA")
levels(faith2$Tour_Region.binned) <- c("FS+MD+CNE+AM+misc", "Other", "BI+IT+EU+EC", "NA")
levels(faith2$SourceType.binned) <- c("Other", "Internet+Referral", "Old Src IDs+misc", "NA")
```

# change ordinal range variables to numeric
# do this by replacing range with a random value between the cutoffs
# (e.g. Book_Months = "4-6 Months", so generate a random number 
# between 4 and 6.999 from the uniform distribution)
```{r}
set.seed(0613)
faith3 <- faith2 %>%
  mutate(Book_Months_num = ifelse(as.numeric(Book_Months) == 1, runif(nrow(.), 10, 12.999),
                       ifelse(as.numeric(Book_Months) == 2, runif(nrow(.), 4, 6.999),
                       ifelse(as.numeric(Book_Months) == 3, runif(nrow(.), 7, 9.999),
                       ifelse(as.numeric(Book_Months) == 4, runif(nrow(.), 13, 15.9999),
                       ifelse(as.numeric(Book_Months) == 5, runif(nrow(.), 0, 3.999), 
                              NA))))),
         Age_num = ifelse(as.numeric(Age) == 1, runif(nrow(.), 30, 39.999),
                   ifelse(as.numeric(Age) == 2, runif(nrow(.), 40, 44.999),
                   ifelse(as.numeric(Age) == 3, runif(nrow(.), 45, 49.999),
                   ifelse(as.numeric(Age) == 4, runif(nrow(.), 50, 54.999),
                   ifelse(as.numeric(Age) == 5, runif(nrow(.), 55, 59.999),
                   ifelse(as.numeric(Age) == 6, runif(nrow(.), 60, 69.999),
                   ifelse(as.numeric(Age) == 7, runif(nrow(.), 70, 79.999),
                   ifelse(as.numeric(Age) == 8, NA,
                   ifelse(as.numeric(Age) == 9, runif(nrow(.), 80, 89.999),
                   ifelse(as.numeric(Age) == 10, runif(nrow(.), 20, 29.999), NA)))))))))),
         DB_Enter_Months_num = ifelse(as.numeric(DB_Enter_Months) == 1, runif(nrow(.), 4, 6.999),
                               ifelse(as.numeric(DB_Enter_Months) == 2, runif(nrow(.), 7, 12.999),
                               ifelse(as.numeric(DB_Enter_Months) == 3, runif(nrow(.), 13, 15.999),
                               ifelse(as.numeric(DB_Enter_Months) == 4, runif(nrow(.), 0, 3.999), 
                                      NA)))),
         TourPriceCat_num = ifelse(as.numeric(TourPriceCat) == 1, runif(nrow(.), 2001, 2500),
                            ifelse(as.numeric(TourPriceCat) == 2, runif(nrow(.), 2501, 3000),
                            ifelse(as.numeric(TourPriceCat) == 3, runif(nrow(.), 3001, 3500),
                            ifelse(as.numeric(TourPriceCat) == 4, runif(nrow(.), 3501, 4000),
                            ifelse(as.numeric(TourPriceCat) == 5, runif(nrow(.), 4001, 4500),
                            ifelse(as.numeric(TourPriceCat) == 6, runif(nrow(.), 4501, 5000),
                            ifelse(as.numeric(TourPriceCat) == 7, runif(nrow(.), 5001, 5500),
                            ifelse(as.numeric(TourPriceCat) == 8, runif(nrow(.), 1501, 2000), 
                                   NA)))))))))
```

# Frequency Distributions
```{r}
# manually plot everything
ggplot(faith3) +
  geom_bar(aes(Tour_Type, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Tour Type")

ggplot(faith3) +
  geom_bar(aes(Main_Ext, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Main Ext")

ggplot(faith3) +
  geom_bar(aes(Pax_Category, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Pax Category")

ggplot(faith3) +
  geom_histogram(aes(Grp_Size, fill = Book_12Mo)) +
  labs(title = "Distribution of Group Size")

ggplot(faith3) +
  geom_histogram(aes(Capacity, fill = Book_12Mo), binwidth = 10) +
  labs(title = "Distribution of Capacity")

ggplot(faith3) +
  geom_bar(aes(Tour_Region.binned, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Tour Region")

ggplot(faith3) +
  geom_bar(aes(TourCode.binned, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Tour Code")

ggplot(faith3) +
  geom_histogram(aes(Book_Months_num, fill = Book_12Mo), binwidth = 1) +
  labs(title = "Distribution of Book Months")

ggplot(faith3) +
  geom_histogram(aes(Age_num, fill = Book_12Mo), binwidth = 5) +
  labs(title = "Distribution of Age")

ggplot(faith3) +
  geom_histogram(aes(DB_Enter_Months_num, fill = Book_12Mo), binwidth = 1) +
  labs(title = "Distribution of DB Enter Months")

ggplot(faith3) +
  geom_bar(aes(Email, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Email")

ggplot(faith3) +
  geom_bar(aes(State.binned, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of State")

ggplot(faith3) +
  geom_bar(aes(SourceType.binned, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Source Type")

ggplot(faith3) +
  geom_histogram(aes(Past_Trips, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Past Trips")

ggplot(faith3) +
  geom_histogram(aes(TourPriceCat_num, fill = Book_12Mo), binwidth = 500) +
  labs(title = "Distribution of Tour Price Category")

ggplot(faith3) +
  geom_bar(aes(Promo_Disc, fill = Book_12Mo), position = "dodge") +
  labs(title = "Distribution of Promo Disc")
```

```{r}
# compute p-values for each variable for Book_12Mo
index.cat<-sapply(faith3, is.factor)
index.cat[17]<-FALSE

index <- sapply(faith3, is.numeric)

chi2pvalues<- sapply(faith3[index.cat], 
                     function(x) chisq.test(x, faith3$Book_12Mo)$p.value)

tvalues <- sapply(faith3[index],
                  function(x) t.test(x ~ faith3$Book_12Mo)$p.value)

summary(filter(faith3, Book_12Mo == 1))
```

